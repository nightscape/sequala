name: Validate Schema Changes

on:
  pull_request:
    paths:
      - 'sql/oracle/DESIRED_STATE/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure GitHub CLI for Enterprise
        run: echo "GH_HOST=${GITHUB_SERVER_URL#https://}" >> "$GITHUB_ENV"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Parse modified SQL files
        id: parse
        run: |
          cd sql/oracle

          # Get list of modified DESIRED_STATE files
          MODIFIED_FILES=$(git diff --name-only origin/develop...HEAD -- DESIRED_STATE/ || echo "")

          if [ -z "$MODIFIED_FILES" ]; then
            echo "No DESIRED_STATE files modified"
            echo "status=skip" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Modified files:"
          echo "$MODIFIED_FILES"

          # Run Sequala parser on modified files
          # This validates SQL syntax and metadata format
          cd ../..
          sbt "sql/compile" 2>&1 | tee /tmp/parse-output.log
          PARSE_EXIT=$?

          if [ $PARSE_EXIT -eq 0 ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
          fi

      - name: Run jq transformations
        if: steps.parse.outputs.status == 'success'
        id: transform
        run: |
          cd sql/oracle

          # Test that jq transformations still work
          # (This validates the metadata structure)
          if [ -f "ddl-to-derived-tables.jq" ]; then
            echo "Running jq transformation test..."
            # Add actual jq test command here
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "No jq transformation file found"
            echo "status=skip" >> "$GITHUB_OUTPUT"
          fi

      - name: Post validation results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PARSE_STATUS="${{ steps.parse.outputs.status }}"

          if [ "$PARSE_STATUS" = "success" ]; then
            EMOJI="✅"
            MESSAGE="Schema validation passed"
          elif [ "$PARSE_STATUS" = "skip" ]; then
            EMOJI="⏭️"
            MESSAGE="No DESIRED_STATE files to validate"
          else
            EMOJI="❌"
            MESSAGE="Schema validation failed"
          fi

          COMMENT=$(cat <<EOF
          ## ${EMOJI} Schema Validation

          **Status:** ${MESSAGE}

          <details>
          <summary>Validation Details</summary>

          - SQL Parsing: ${{ steps.parse.outputs.status || 'not run' }}
          - JQ Transformations: ${{ steps.transform.outputs.status || 'not run' }}

          </details>
          EOF
          )

          gh pr comment "$PR_NUMBER" --body "$COMMENT"
