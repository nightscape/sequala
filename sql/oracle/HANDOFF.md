# Roundtrip Test - Remaining Issues Handoff

## Context

This document describes the remaining issues in the Oracle roundtrip test after successfully fixing the trailing newline bug that caused ORA-03405 errors.

## What Was Fixed âœ…

### 1. Trailing Newline Bug (COMPLETED)
**Problem**: Sequala CLI's `writeToFile` function didn't add trailing newlines to generated SQL files. When files were concatenated with `cat`, statements merged onto single lines:
```sql
...NULL);INSERT INTO...
```
This caused **ORA-03405: End of query reached** errors.

**Fix Applied**: Modified `cli/src/main/scala/sequala/parse/ParseCommand.scala:448-451`
```scala
try {
  writer.print(content)
  if content.nonEmpty && !content.endsWith("\n") then writer.print("\n")
} finally writer.close()
```

**Verification**: ORA-03405 errors reduced from 20+ to **0** âœ…

### 2. Database Link Configuration (COMPLETED)
**Problem**: Status check used `grep -q "1"` which matched "line **1**" in error messages.

**Fix Applied**: `sql/oracle/Taskfile.yml:587`
```yaml
status:
  - echo "SELECT 1 FROM dual@orig_db;" | docker exec -i "{{.NEW_CONTAINER}}" sqlplus -s "{{.SQLPLUS_CONN}}" 2>&1 | grep -v "ERROR" | grep -q "^[[:space:]]*1[[:space:]]*$"
```

Also added container-to-container connection strings for database links.

---

## Remaining Issues ðŸ”´

### Issue 1: Missing Schema Users (HIGH PRIORITY)
**Error**: ORA-01918: user 'GUI_XMDM_XXX' does not exist

**Affected Schemas**:
- GUI_XMDM_MMPM_WIF (~10 tables)
- GUI_XMDM_REV_SHARING (~52 tables)
- GUI_XMDM_SCS
- GUI_XMDM_XETRA_HFT
- GUI_XMDM_XETRA_HYPMI
- GUI_XMDM_XETRA_RTS24
- GUI_XMDM_ZEPPELIN
- GUI_XMDM_RRS
- GUI_XMDM_LST

**Root Cause**: The `DESIRED_STATE/` files extracted from `sql/oracle/sqls.tar` contain tables for schemas that aren't created in the test database.

**Where to Find Files**:
- Source: `/Users/martin/Workspaces/scala/sequala/sql/oracle/DESIRED_STATE/`
- Problem files: `GUI_XMDM_MMPM_WIF-PROD-tables.sql`, `GUI_XMDM_REV_SHARING-PROD-tables.sql`, etc.

**Investigation Steps**:
1. Check which schemas are actually needed:
   ```bash
   cd /Users/martin/Workspaces/scala/sequala/sql/oracle
   ls -1 DESIRED_STATE/*-PROD-tables.sql | xargs -I {} basename {} -PROD-tables.sql | sort
   ```

2. Check which schemas have setup scripts in `_setup.sql`:
   ```bash
   grep "CREATE USER" DESIRED_STATE/_setup.sql
   ```

3. Either:
   - **Option A**: Add CREATE USER statements for missing schemas to `DESIRED_STATE/_setup.sql`
   - **Option B**: Remove the DESIRED_STATE files for schemas that don't belong in this test

**Recommended Fix**: Check git history to see if these files were intentionally deleted:
```bash
git log --all --full-history -- sql/oracle/DESIRED_STATE/GUI_XMDM_MMPM_WIF-PROD-tables.sql
```

If they were deleted, remove them from the tar backup extraction.

---

### Issue 2: NUMBER Precision Out of Range (MEDIUM PRIORITY)
**Error**: ORA-01727: numeric precision specifier is out of range (1 to 38)

**Occurrences**: 4 instances

**Root Cause**: Some DDL files contain `NUMBER(126)` which exceeds Oracle's maximum precision of 38.

**Investigation**:
```bash
grep -n "NUMBER(126)" DESIRED_STATE/*.sql
```

**Fix**: Update the DESIRED_STATE files to use valid precision:
```sql
# Change from:
NUMBER(126)
# To:
NUMBER(38)
```

Or investigate if this should be `NUMBER(38, 88)` (precision 38, scale 88 is invalid too - likely a data modeling error).

---

### Issue 3: Reserved Word Column Name (LOW PRIORITY)
**Error**: ORA-03050: invalid identifier: "UNION" is a reserved word

**Occurrences**: 4 instances

**Root Cause**: A column is named `UNION` which is a SQL reserved word and must be quoted.

**Investigation**:
```bash
grep -n '"UNION"' DESIRED_STATE/*.sql | grep -v "UNION ALL"
```

**Fix**: Ensure the column name is quoted:
```sql
"UNION" VARCHAR2(50)  -- Correct
UNION VARCHAR2(50)    -- Incorrect
```

---

### Issue 4: APP_NAME Too Long (LOW PRIORITY - May be expected)
**Error**: ORA-12899: value too large for column "GUI_XMDM"."XMDM_CONF_COLUMN"."APP_NAME"

**Occurrences**: ~459 instances

**Root Cause**: `APP_NAME='GUI_XMDM_DATA_PLATFORM'` (23 chars) exceeds `VARCHAR2(20 BYTE)`.

**Location**: Metadata INSERT statements generated by `sql/oracle/ddl-to-sync.jq`

**Options**:
1. **Expand the column**: Alter XMDM_CONF_COLUMN.APP_NAME to VARCHAR2(30)
2. **Truncate app names**: Modify `ddl-to-sync.jq` to truncate schema names
3. **Skip these inserts**: These might be optional metadata

**Investigation**: Check if XMDM_CONF_COLUMN exists and what its actual schema is:
```bash
grep -A 5 "CREATE TABLE.*XMDM_CONF_COLUMN" DESIRED_STATE/*.sql
```

---

## Running Tests

### Clean and Run Full Roundtrip Test
```bash
cd /Users/martin/Workspaces/scala/sequala/sql/oracle

# Clean everything
task roundtrip:clean
docker exec oracle-new sqlplus -s "system/orakel@//localhost/FREEPDB1" <<'EOF'
DROP DATABASE LINK orig_db;
EXIT;
EOF

# Run test
task roundtrip-test 2>&1 | tee roundtrip-test-new.log

# Check errors
grep -c "ORA-" roundtrip-test-new.log
grep "ORA-01918" roundtrip-test-new.log | head -20  # Missing schemas
grep "ORA-01727" roundtrip-test-new.log              # NUMBER precision
grep "ORA-03050" roundtrip-test-new.log              # Reserved words
```

### Quick Error Analysis
```bash
# Count each error type
for code in 01918 01727 03050 12899 00955; do
  count=$(grep -c "ORA-$code" roundtrip-test-new.log)
  echo "ORA-$code: $count"
done
```

---

## Key Files

### Source Code
- **CLI Writer**: `cli/src/main/scala/sequala/parse/ParseCommand.scala:443-452` (FIXED)
- **Taskfile**: `sql/oracle/Taskfile.yml`
- **JQ Transform**: `sql/oracle/ddl-to-sync.jq` (generates metadata INSERTs)

### Test Data
- **DESIRED_STATE**: `sql/oracle/DESIRED_STATE/*-PROD-tables.sql` (47 files, extracted from sqls.tar)
- **Setup Script**: `sql/oracle/DESIRED_STATE/_setup.sql` (creates users/tablespaces)
- **Backup**: `sql/oracle/sqls.tar` (original files before fixes)

### Logs
- **Latest test**: `sql/oracle/roundtrip-final-success.log`
- **Previous tests**: `sql/oracle/roundtrip-test*.log`

---

## Success Criteria

The roundtrip test should:
1. âœ… Have 0 ORA-03405 errors (concatenation) - **ACHIEVED**
2. ðŸ”² Have 0 ORA-01918 errors (missing schemas)
3. ðŸ”² Have 0 ORA-01727 errors (NUMBER precision)
4. ðŸ”² Have 0 ORA-03050 errors (reserved words)
5. ðŸ”² Show "Tables compared: N, Identical: N, Different: 0" at the end
6. âš ï¸  ORA-00955 (name exists) - Expected during idempotent re-runs, can ignore
7. âš ï¸  ORA-12899 (APP_NAME too long) - May be acceptable if metadata is optional

**Final Goal**: The roundtrip test demonstrates that:
- DDL can be dumped from oracle-orig
- Applied to oracle-new
- Both databases are structurally identical (0 differences)

---

## Hypotheses for Next Session

### Hypothesis 1: DESIRED_STATE Files from Wrong Backup
The `sqls.tar` contains DESIRED_STATE files from a different/older environment that includes schemas not used in this test setup.

**Test**: Compare tar contents with git history:
```bash
tar -tf sql/oracle/sqls.tar | grep "DESIRED_STATE.*PROD-tables.sql" | wc -l
git log --oneline --all -- "sql/oracle/DESIRED_STATE/*-PROD-tables.sql" | wc -l
```

### Hypothesis 2: _setup.sql Is Incomplete
The setup script doesn't create all required schemas.

**Test**: Extract required schemas from DESIRED_STATE files and compare with _setup.sql:
```bash
# Schemas in DESIRED_STATE
ls -1 DESIRED_STATE/*-PROD-tables.sql | sed 's/.*\/\(.*\)-PROD-tables.sql/\1/' | sort > /tmp/schemas-in-files.txt

# Schemas in _setup.sql
grep -o "CREATE USER GUI_XMDM[^ ]*" DESIRED_STATE/_setup.sql | sed 's/CREATE USER //' | sort > /tmp/schemas-in-setup.txt

# Compare
comm -23 /tmp/schemas-in-files.txt /tmp/schemas-in-setup.txt
```

### Hypothesis 3: NUMBER(126) Is a Parser Bug
The original source doesn't have NUMBER(126), but Sequala generated it incorrectly.

**Test**: Check original source in git or database:
```bash
# If original sources exist
grep "NUMBER(126)" sql/oracle/*/original/*.sql
```

---

## Quick Wins

Start here for fastest progress:

1. **Remove problematic DESIRED_STATE files** (5 min):
   ```bash
   rm DESIRED_STATE/GUI_XMDM_MMPM_WIF-PROD-tables.sql
   rm DESIRED_STATE/GUI_XMDM_REV_SHARING-PROD-tables.sql
   rm DESIRED_STATE/GUI_XMDM_RRS-PROD-tables.sql
   rm DESIRED_STATE/GUI_XMDM_LST-PROD-tables.sql
   # ... etc for all missing schema errors
   ```

2. **Fix NUMBER(126) errors** (10 min):
   ```bash
   sed -i.bak 's/NUMBER(126)/NUMBER(38)/g' DESIRED_STATE/*.sql
   ```

3. **Fix reserved word column** (5 min):
   ```bash
   # Find and manually fix unquoted UNION column names
   grep -n 'UNION VARCHAR' DESIRED_STATE/*.sql
   ```

4. **Re-run test** and check if we're closer to 0 differences.

---

## Environment Info

- **Working Dir**: `/Users/martin/Workspaces/scala/sequala/sql/oracle`
- **Database Containers**: `oracle-orig` (port 1521), `oracle-new` (port 1522)
- **Database**: Oracle Free 23ai
- **Service Name**: FREEPDB1
- **Password**: orakel
- **Sequala CLI**: `cli/target/scala-3.3.6/sequala-cli-2.0.0-M6.jar` (rebuilt with trailing newline fix)

---

## Context for LLM

When starting the next session, use this prompt:

> I'm continuing work on fixing the Oracle roundtrip test. In the previous session, we successfully fixed the trailing newline bug in Sequala CLI (ORA-03405 errors eliminated). Now I need to fix the remaining issues documented in `/Users/martin/Workspaces/scala/sequala/sql/oracle/HANDOFF.md`.
>
> Please read the HANDOFF.md file and help me:
> 1. Investigate which DESIRED_STATE files should be removed (Hypothesis 1)
> 2. Fix the NUMBER(126) precision errors
> 3. Fix the reserved word errors
> 4. Get the roundtrip test to pass with 0 schema differences
>
> The working directory is `/Users/martin/Workspaces/scala/sequala/sql/oracle`. Start by reading HANDOFF.md and the latest test log to understand the current state.

---

## Additional Notes

- The trailing newline fix is **committed to the codebase** and working correctly
- All DESIRED_STATE files now have proper trailing newlines
- The database link between oracle-new and oracle-orig is working
- The metadata generation pipeline (ddl-to-sync.jq) is working for most schemas
- Main blocker is the missing schema users causing ~100+ errors

---

Generated: 2026-01-07
Session: Roundtrip test debugging - Phase 1 complete
